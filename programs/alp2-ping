loader.loadAPI("alp2")

args = { ... }

function run()
  if not args[1] then 
    print("alp2-ping <address>")
    return
  end
  print("Pinging " .. args[1])
  local startTime = os.clock()
  alp2.sendPacket(
    alp2.getDevices(),
    "ping.transmit",
    args[1],
    "This is a ping packet"
  )
  alp2.openDevices(alp2.getDevices())
  -- now wait a while for some responses
  local timeout = 10
  if args[2] then
    timeout = 0 + args[2]
  end
  local gotReply = false
  while os.clock() - startTime < timeout do
    local wait = startTime + timeout - os.clock()
    local response = alp2.waitForPacket("ping.reply", wait)
    if response ~= nil then
      local timeTaken = os.clock() - startTime
      print("Reply from " .. response.src .. " after " .. timeTaken .. " seconds")
      gotReply = true
    end
  end
  if not gotReply then
    local timeTaken = os.clock() - startTime
    print("No reponse after " .. timeTaken .. " seconds")
  end
end
run()

