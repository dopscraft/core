loader.loadAPI("alp2")

args = { ... }

function run()
  if not args[1] then 
    print("alp2-ping <address> [ <timeout> [ <protocol> ] ]")
    return
  end
  print("Pinging " .. args[1])
  local startTime = os.clock()
  local protocol = "ping"
  if args[3] then
    protocol = args[3]
  end
  alp2.sendPacket(
    alp2.getDevices(),
    protocol .. ".transmit",
    args[1],
    "PING!"
  )
  alp2.openDevices(alp2.getDevices())
  -- now wait a while for some responses
  local timeout = 4
  if args[2] then
    timeout = 0 + args[2]
  end
  local gotReply = false
  while os.clock() - startTime < timeout do
    local wait = startTime + timeout - os.clock()
    local response = alp2.waitForPacket(protocol .. ".reply", wait)
    if response ~= nil then
      local timeTaken = os.clock() - startTime
      print("Reply from " .. response.src .. " after " .. timeTaken .. " s:")
      print(string.sub(response.data, 1, 50))
      gotReply = true
    end
  end
  if not gotReply then
    local timeTaken = os.clock() - startTime
    print("No reponse after " .. timeTaken .. " seconds")
  end
end
run()

